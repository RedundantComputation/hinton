<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Media — Videos</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #ffefca; font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; }
    .media-grid .card { transition: transform .12s ease, box-shadow .12s ease; }
    .media-grid .card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0,0,0,0.12); }
    .media-meta { color: #6c757d; font-size: .9rem; }
    /* Ensure all thumbnail containers use the same aspect ratio so titles align */
    .thumb-wrap { position: relative; width: 100%; padding-top: 56.25%; /* 16:9 */ overflow: hidden; border-radius: 0.25rem; background: #f0f0f0; }
    .thumb-link { position: absolute; inset: 0; display: block; }
    .thumb-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; display: block; }
    .play-overlay { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 2rem; color: rgba(255,255,255,0.95); text-shadow: 0 3px 8px rgba(0,0,0,0.6); pointer-events: none; }
    /* Keep card body layout consistent */
    .card-body { display: flex; flex-direction: column; }
    .card-title { margin-top: 0.75rem; }
  </style>
</head>
<body>
  <header class="py-3 bg-white border-bottom sticky-top">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center">
        <h1 class="h4 mb-0"><a href="/hinton/" class="text-decoration-none text-dark"><span class="me-2">←</span>Geoffrey E. Hinton</a></h1>
        <span class="text-muted">Media</span>
      </div>
    </div>
  </header>

  <main class="py-4">
    <div class="container">

      <!-- Grid root -->
      <div id="media-root" class="row media-grid g-3"></div>

      <!-- Template: thumbnail links out to the video (opens in new tab) -->
      <template id="media-item-tpl">
        <div class="col-lg-4 col-md-6 col-sm-12">
          <div class="card h-100 shadow-sm">
            <div class="card-body d-flex flex-column">
              <div class="thumb-wrap mb-3">
                <a class="thumb-link" target="_blank" rel="noopener noreferrer" href="#" aria-label="Open video in new tab">
                  <img class="thumb-img" alt="video thumbnail">
                  <span class="play-overlay" aria-hidden="true">▶</span>
                </a>
              </div>
              <h5 class="card-title mb-2"></h5>
              <p class="media-meta mb-3"></p>
            </div>
          </div>
        </div>
      </template>

    </div>
  </main>

  <script>
    (function(){
      const tpl = document.getElementById('media-item-tpl');
      const root = document.getElementById('media-root');

      function tryParseDate(s) {
        if (!s) return null;
        // Try native parse
        const d1 = new Date(s);
        if (!isNaN(d1)) return d1;
        // Try treating "Month YYYY" as first day of month
        const d2 = new Date('1 ' + s);
        if (!isNaN(d2)) return d2;
        // Try ISO fallback
        const d3 = new Date(s.replace(/^(\d{4})-(\d{2})$/, '$1-$2-01'));
        if (!isNaN(d3)) return d3;
        return null;
      }

      function extractYouTubeID(url) {
        if (!url) return null;
        const m = url.match(/(?:v=|\/videos\/|embed\/|youtu\.be\/)([A-Za-z0-9_-]{6,})/);
        return m ? m[1] : null;
      }

      function makeThumbUrl(id) {
        return `https://i.ytimg.com/vi/${id}/hqdefault.jpg`;
      }

      function render(items) {
        root.innerHTML = '';
        items.forEach(item => {
          const clone = tpl.content.firstElementChild.cloneNode(true);
          clone.querySelector('.card-title').textContent = item.title || '';
          clone.querySelector('.media-meta').textContent = item.date || '';

          const linkEl = clone.querySelector('.thumb-link');
          const imgEl = clone.querySelector('.thumb-img');

          const href = item.link || item.href || '#';
          linkEl.href = href;
          // Prefer explicit thumbnail field, then YouTube-derived thumb, else leave blank
          if (item.thumbnail) {
            imgEl.src = item.thumbnail;
          } else {
            const id = item.youtubeId || extractYouTubeID(href);
            if (id) imgEl.src = makeThumbUrl(id);
            else imgEl.src = '';
          }
          // lazy-load images for performance and add a graceful fallback
          imgEl.loading = 'lazy';
          imgEl.alt = item.title ? `Thumbnail for ${item.title}` : 'Video thumbnail';
          imgEl.addEventListener('error', function onErr() {
            // If the explicit thumbnail failed to load, try deriving from YouTube id
            const id = item.youtubeId || extractYouTubeID(href);
            if (id && imgEl.src !== makeThumbUrl(id)) {
              imgEl.src = makeThumbUrl(id);
              return;
            }
            // final fallback: small built-in placeholder (SVG data URI)
            imgEl.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(`
              <svg xmlns="http://www.w3.org/2000/svg" width="640" height="360" viewBox="0 0 16 9">
                <rect width="16" height="9" fill="#ddd" />
                <text x="8" y="4.6" font-size="0.9" text-anchor="middle" fill="#666" font-family="Arial, Helvetica, sans-serif">No thumbnail</text>
              </svg>
            `);
            // remove this handler to avoid infinite loops
            imgEl.removeEventListener('error', onErr);
          });

          root.appendChild(clone);
        });
      }

      function loadAndRender() {
        fetch('videos.json')
          .then(r => { if (!r.ok) throw new Error('Failed to load videos.json'); return r.json(); })
          .then(data => {
            // Expect an array of items
            let items = Array.isArray(data) ? data.slice() : (Array.isArray(data.items) ? data.items.slice() : []);

            // Attach parsedDate for sorting
            items.forEach(it => {
              it._parsedDate = tryParseDate(it.date) || tryParseDate(it.sortDate) || null;
            });

            // Sort new -> old; items without dates go last
            items.sort((a,b) => {
              if (a._parsedDate && b._parsedDate) return b._parsedDate - a._parsedDate;
              if (a._parsedDate) return -1;
              if (b._parsedDate) return 1;
              return 0;
            });

            render(items);
          })
          .catch(err => {
            root.innerHTML = '<div class="col-12"><div class="alert alert-warning">Unable to load videos.json — check console for details.</div></div>';
            console.error(err);
          });
      }

      document.addEventListener('DOMContentLoaded', loadAndRender);
    })();
  </script>
</body>
</html>
